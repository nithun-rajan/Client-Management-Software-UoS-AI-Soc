name: Secret Scanning

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  gitleaks:
    name: Scan for Secrets with Gitleaks
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scan

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional: for commercial features

      - name: Upload Gitleaks Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

  trufflehog:
    name: Scan for Secrets with TruffleHog
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Upload TruffleHog Results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-report
          path: trufflehog-results.json
          retention-days: 30

  detect-secrets:
    name: Scan with detect-secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install detect-secrets
        run: |
          pip install detect-secrets

      - name: Create baseline if not exists
        run: |
          if [ ! -f .secrets.baseline ]; then
            detect-secrets scan --baseline .secrets.baseline
          fi

      - name: Scan for new secrets
        run: |
          detect-secrets scan --baseline .secrets.baseline \
            --exclude-files '\.git/.*' \
            --exclude-files '.*\.lock$' \
            --exclude-files '.*\.sum$' \
            --exclude-files 'package-lock\.json$' \
            --exclude-files 'bun\.lockb$' \
            --exclude-files '.*\.md$'

      - name: Audit baseline
        run: |
          detect-secrets audit .secrets.baseline

  env-file-check:
    name: Check for Committed .env Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for .env files
        run: |
          echo "üîç Checking for accidentally committed .env files..."

          # Find .env files (excluding .env.example, .env.template, etc.)
          FOUND_ENV_FILES=$(git ls-files | grep -E '\.env$|\.env\.local$|\.env\.development$|\.env\.production$' || true)

          if [ -n "$FOUND_ENV_FILES" ]; then
            echo "‚ùå ERROR: Found .env files committed to repository:"
            echo "$FOUND_ENV_FILES"
            echo ""
            echo "These files should NOT be committed as they may contain secrets."
            echo "Please:"
            echo "1. Remove them: git rm --cached <file>"
            echo "2. Add to .gitignore"
            echo "3. Rotate any exposed secrets"
            exit 1
          else
            echo "‚úÖ No .env files found in repository"
          fi

      - name: Check for common secret patterns
        run: |
          echo "üîç Checking for common secret patterns..."

          # Check for AWS keys
          if git grep -i 'AKIA[0-9A-Z]{16}' -- ':!.github/workflows'; then
            echo "‚ùå Potential AWS access key found!"
            exit 1
          fi

          # Check for private keys
          if git grep -i 'BEGIN.*PRIVATE KEY' -- ':!.github/workflows'; then
            echo "‚ùå Potential private key found!"
            exit 1
          fi

          # Check for database URLs with passwords
          if git grep -E 'postgresql://[^:]+:[^@]+@' -- ':!backend/.env.example' ':!backend/.env.preview.example' ':!docs' ':!.github'; then
            echo "‚ùå Potential database URL with password found!"
            exit 1
          fi

          echo "‚úÖ No obvious secret patterns found"

  summary:
    name: Secret Scanning Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, detect-secrets, env-file-check]
    if: always()

    permissions:
      pull-requests: write

    steps:
      - name: Create Summary
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const gitleaksResult = '${{ needs.gitleaks.result }}';
            const trufflehogResult = '${{ needs.trufflehog.result }}';
            const detectSecretsResult = '${{ needs.detect-secrets.result }}';
            const envFileCheckResult = '${{ needs.env-file-check.result }}';

            const allPassed =
              gitleaksResult === 'success' &&
              trufflehogResult === 'success' &&
              detectSecretsResult === 'success' &&
              envFileCheckResult === 'success';

            const emoji = allPassed ? '‚úÖ' : 'üö®';
            const status = allPassed ? 'PASSED' : 'FAILED';

            const comment = `## ${emoji} Secret Scanning ${status}

            | Scanner | Status |
            |---------|--------|
            | Gitleaks | ${gitleaksResult === 'success' ? '‚úÖ Pass' : '‚ùå Fail'} |
            | TruffleHog | ${trufflehogResult === 'success' ? '‚úÖ Pass' : '‚ùå Fail'} |
            | detect-secrets | ${detectSecretsResult === 'success' ? '‚úÖ Pass' : '‚ùå Fail'} |
            | .env File Check | ${envFileCheckResult === 'success' ? '‚úÖ Pass' : '‚ùå Fail'} |

            ${allPassed ?
              'üéâ No secrets detected in your changes!' :
              '‚ö†Ô∏è **Potential secrets detected!** Please review the scan results and remove any sensitive data before merging.'
            }

            ### What to do if secrets are found:

            1. **Remove the secret** from your code
            2. **Rotate the secret** immediately if it was exposed
            3. **Add it to .gitignore** if it's a file
            4. **Use environment variables** instead of hardcoding
            5. **Update .secrets.baseline** if it's a false positive

            ### Resources:
            - [Secrets Management Guide](../docs/SECRETS_MANAGEMENT.md)
            - [Environment Variables](../.github/SECRETS.md)
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
