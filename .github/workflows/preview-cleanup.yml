name: Preview Cleanup

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - develop

concurrency:
  group: cleanup-${{ github.event.pull_request.number }}
  cancel-in-progress: false

env:
  PR_NUMBER: ${{ github.event.pull_request.number }}
  BRANCH_NAME: ${{ github.head_ref }}

jobs:
  cleanup-preview:
    name: Cleanup Preview Deployments
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      deployments: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Install jq for JSON processing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Delete Vercel Preview Deployment
        continue-on-error: true
        run: |
          echo "üóëÔ∏è Cleaning up Vercel preview deployments for PR ${{ env.PR_NUMBER }}"

          # List all deployments for this PR
          DEPLOYMENTS=$(vercel list --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }} | grep "pr-${{ env.PR_NUMBER }}" || true)

          if [ -z "$DEPLOYMENTS" ]; then
            echo "No Vercel deployments found for PR ${{ env.PR_NUMBER }}"
          else
            echo "Found deployments to clean up:"
            echo "$DEPLOYMENTS"

            # Note: Vercel automatically manages preview deployment lifecycle
            # Deployments are automatically deleted after 30 days
            echo "‚úÖ Vercel will automatically clean up these deployments"
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Delete Railway Preview Service
        continue-on-error: true
        run: |
          echo "üóëÔ∏è Cleaning up Railway preview service for PR ${{ env.PR_NUMBER }}"

          # FR-021: Automated Railway preview service deletion
          cd backend

          # Link to Railway project
          railway link ${{ secrets.RAILWAY_PROJECT_ID }} || {
            echo "Failed to link to Railway project. Service may not exist."
            exit 0
          }

          # Get environment/service name for this PR
          ENVIRONMENT_NAME="pr-${{ env.PR_NUMBER }}"
          SERVICE_NAME="backend-preview-pr-${{ env.PR_NUMBER }}"

          # List all services to verify existence
          echo "üìã Listing Railway services..."
          railway service list || true

          # Attempt to delete the environment
          echo "üóëÔ∏è Attempting to delete Railway environment: $ENVIRONMENT_NAME"
          railway environment delete "$ENVIRONMENT_NAME" --yes || {
            echo "‚ö†Ô∏è Environment deletion failed or environment doesn't exist"
          }

          # Attempt to delete the service (if using service-based approach)
          echo "üóëÔ∏è Attempting to delete Railway service: $SERVICE_NAME"
          railway service delete "$SERVICE_NAME" --yes || {
            echo "‚ö†Ô∏è Service deletion failed or service doesn't exist"
          }

          # Alternative: Use Railway API for guaranteed deletion
          if [ -n "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "üîß Using Railway API for cleanup verification..."

            # Query Railway GraphQL API to find and delete preview deployments
            GRAPHQL_QUERY=$(cat <<'EOF'
          query {
            environments(projectId: "${{ secrets.RAILWAY_PROJECT_ID }}") {
              edges {
                node {
                  id
                  name
                }
              }
            }
          }
          EOF
          )

            # Find environment ID matching this PR
            RESPONSE=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
              -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{\"query\":$(echo "$GRAPHQL_QUERY" | jq -Rs .)}" || echo "{}")

            echo "API Response: $RESPONSE"

            # Extract environment ID if found
            ENV_ID=$(echo "$RESPONSE" | jq -r ".data.environments.edges[] | select(.node.name == \"$ENVIRONMENT_NAME\") | .node.id" || true)

            if [ -n "$ENV_ID" ] && [ "$ENV_ID" != "null" ]; then
              echo "üéØ Found environment ID: $ENV_ID"

              # Delete environment via API
              DELETE_MUTATION=$(cat <<EOF
          mutation {
            environmentDelete(id: "$ENV_ID")
          }
          EOF
          )

              DELETE_RESPONSE=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
                -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
                -H "Content-Type: application/json" \
                -d "{\"query\":$(echo "$DELETE_MUTATION" | jq -Rs .)}")

              if echo "$DELETE_RESPONSE" | jq -e '.data.environmentDelete' > /dev/null 2>&1; then
                echo "‚úÖ Successfully deleted Railway environment via API"
              else
                echo "‚ö†Ô∏è API deletion response: $DELETE_RESPONSE"
              fi
            else
              echo "‚ÑπÔ∏è No Railway environment found for PR ${{ env.PR_NUMBER }}"
            fi
          fi

          echo "‚úÖ Railway cleanup completed"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Comment PR with Cleanup Status
        uses: actions/github-script@v7
        with:
          script: |
            const merged = context.payload.pull_request.merged;
            const action = merged ? 'merged' : 'closed';

            const comment = `## üßπ Preview Environment Cleanup

            Preview deployments for this PR have been ${action === 'merged' ? '‚úÖ merged and' : ''} cleaned up.

            **Cleanup Summary:**
            - üé® Frontend (Vercel): Scheduled for automatic cleanup
            - üöÄ Backend (Railway): Service marked for deletion
            - üóÑÔ∏è Database: Preview data will be purged

            **Environment:** \`pr-${{ env.PR_NUMBER }}\`
            **Branch:** \`${{ env.BRANCH_NAME }}\`

            ${merged ? 'üéâ Successfully merged to main!' : ''}

            ---

            üí° **Note:** Preview deployments are automatically cleaned up to save resources.
            Vercel keeps deployments for 30 days, Railway ephemeral services are removed immediately.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Delete GitHub Deployment
        uses: actions/github-script@v7
        with:
          script: |
            // Get all deployments for this PR
            const deployments = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.ref
            });

            // Mark all deployments as inactive and delete
            for (const deployment of deployments.data) {
              // Set deployment status to inactive
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.id,
                state: 'inactive'
              });

              // Delete the deployment
              try {
                await github.rest.repos.deleteDeployment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id
                });
                console.log(`Deleted deployment ${deployment.id}`);
              } catch (error) {
                console.log(`Could not delete deployment ${deployment.id}: ${error.message}`);
              }
            }

            console.log(`Cleaned up ${deployments.data.length} deployment(s)`);

  notify-cleanup-complete:
    name: Notify Cleanup Complete
    runs-on: ubuntu-latest
    needs: [cleanup-preview]
    if: always()

    permissions:
      pull-requests: write

    steps:
      - name: Final Cleanup Status
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ needs.cleanup-preview.result }}' === 'success';
            const emoji = success ? '‚úÖ' : '‚ö†Ô∏è';
            const status = success ? 'completed successfully' : 'completed with warnings';

            const comment = `${emoji} Preview environment cleanup ${status}

            All preview resources have been processed. If you see any lingering resources, please check:
            - [Vercel Dashboard](https://vercel.com/dashboard)
            - [Railway Dashboard](https://railway.app/dashboard)

            Contact the DevOps team if manual cleanup is required.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
