name: PR Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - uses: actions/checkout@v4

      - name: PR Details
        run: |
          echo "üìã PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          echo "üë§ Author: ${{ github.event.pull_request.user.login }}"
          echo "üåø Branch: ${{ github.event.pull_request.head.ref }} -> ${{ github.event.pull_request.base.ref }}"
          echo "üìù Files changed: ${{ github.event.pull_request.changed_files }}"

  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Check PR title format
        run: |
          TITLE="${{ github.event.pull_request.title }}"

          # Check if title follows conventional commit format or is descriptive
          if [[ ! "$TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: ]]; then
            echo "‚ö†Ô∏è Warning: PR title should follow conventional commit format"
            echo "Examples: 'feat: add login', 'fix(api): resolve bug', 'docs: update readme'"
            echo "Current title: $TITLE"
            # Don't fail, just warn
          else
            echo "‚úÖ PR title follows conventional commit format"
          fi

  check-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
      specs: ${{ steps.changes.outputs.specs }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: changes
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

          # Check for backend changes
          if git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -q '^backend/'; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "üì¶ Backend changes detected"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "üì¶ No backend changes"
          fi

          # Check for frontend changes
          if git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -q '^frontend/'; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "üé® Frontend changes detected"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "üé® No frontend changes"
          fi

          # Check for spec changes
          if git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -q '^specs/'; then
            echo "specs=true" >> $GITHUB_OUTPUT
            echo "üìã Spec changes detected"
          else
            echo "specs=false" >> $GITHUB_OUTPUT
            echo "üìã No spec changes"
          fi

  backend-checks:
    name: Backend CI
    needs: check-changes
    if: needs.check-changes.outputs.backend == 'true' && github.event.pull_request.draft == false
    uses: ./.github/workflows/backend-ci.yml

  frontend-checks:
    name: Frontend CI
    needs: check-changes
    if: needs.check-changes.outputs.frontend == 'true' && github.event.pull_request.draft == false
    uses: ./.github/workflows/frontend-ci.yml

  pr-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [check-changes, backend-checks, frontend-checks]
    if: always() && github.event.pull_request.draft == false

    steps:
      - name: Summary
        run: |
          echo "## PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Backend status
          if [[ "${{ needs.check-changes.outputs.backend }}" == "true" ]]; then
            if [[ "${{ needs.backend-checks.result }}" == "success" ]]; then
              echo "- ‚úÖ Backend CI: Passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚ùå Backend CI: Failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- ‚è≠Ô∏è Backend CI: Skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi

          # Frontend status
          if [[ "${{ needs.check-changes.outputs.frontend }}" == "true" ]]; then
            if [[ "${{ needs.frontend-checks.result }}" == "success" ]]; then
              echo "- ‚úÖ Frontend CI: Passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚ùå Frontend CI: Failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- ‚è≠Ô∏è Frontend CI: Skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check overall status
        run: |
          BACKEND_OK="true"
          FRONTEND_OK="true"

          if [[ "${{ needs.check-changes.outputs.backend }}" == "true" ]] && [[ "${{ needs.backend-checks.result }}" != "success" ]]; then
            BACKEND_OK="false"
          fi

          if [[ "${{ needs.check-changes.outputs.frontend }}" == "true" ]] && [[ "${{ needs.frontend-checks.result }}" != "success" ]]; then
            FRONTEND_OK="false"
          fi

          if [[ "$BACKEND_OK" == "false" ]] || [[ "$FRONTEND_OK" == "false" ]]; then
            echo "‚ùå PR validation failed"
            exit 1
          fi

          echo "‚úÖ PR validation passed"
