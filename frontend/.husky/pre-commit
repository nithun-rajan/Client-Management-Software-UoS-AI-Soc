#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Check for .env files being committed (but allow .env.example and .env.*.example)
if git diff --cached --name-only | grep -E '\.env$|\.env\..*$' | grep -v '\.example$'; then
  echo "❌ Error: Attempting to commit .env file(s)!"
  echo "   .env files contain secrets and should never be committed."
  echo "   Please unstage them with: git reset HEAD <file>"
  exit 1
fi

# Check for actual secret values (not just variable names or type annotations)
# Look for secret keywords followed by = and a quoted string value
# Exclude: type annotations (: str), variable-to-variable assignments (=var_name)
if git diff --cached | grep -E '\+.*\b(password|api_key|secret|token|private_key)\s*=\s*["\047][^"\047]{8,}["\047]' | grep -v '(your-|example-|test-|mock-|fake-|dummy-|sample-|placeholder-)'; then
  echo "⚠️  Warning: Potential secret VALUE detected in staged changes!"
  echo "   Found assignment patterns like: secret_key = \"actual-value\""
  echo "   Please review your changes carefully."
  echo ""
  read -p "   Continue with commit anyway? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

echo "✅ Pre-commit checks passed"
