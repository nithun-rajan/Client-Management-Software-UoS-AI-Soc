# Pre-commit hooks configuration
# Install: pip install pre-commit
# Setup: pre-commit install
# Run manually: pre-commit run --all-files

repos:
  # Secret detection with Gitleaks
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.18.2
    hooks:
      - id: gitleaks
        name: Detect secrets with Gitleaks
        description: Scan for hardcoded secrets
        entry: gitleaks protect --verbose --redact --staged
        language: system
        pass_filenames: false

  # detect-secrets - Yelp's secret scanner
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        name: Detect secrets
        args:
          - '--baseline'
          - '.secrets.baseline'
          - '--exclude-files'
          - '.*\.lock$'
          - '--exclude-files'
          - 'package-lock\.json$'
          - '--exclude-files'
          - 'bun\.lockb$'

  # Standard pre-commit hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # Prevent committing to main directly
      - id: no-commit-to-branch
        name: Prevent commits to main branch
        args: ['--branch', 'main', '--branch', 'master']

      # Check for files that would conflict in case-insensitive filesystems
      - id: check-case-conflict
        name: Check for case conflicts

      # Ensure files end with newline
      - id: end-of-file-fixer
        name: Fix end of files

      # Remove trailing whitespace
      - id: trailing-whitespace
        name: Trim trailing whitespace
        args: [--markdown-linebreak-ext=md]

      # Check for merge conflicts
      - id: check-merge-conflict
        name: Check for merge conflicts

      # Check YAML files
      - id: check-yaml
        name: Check YAML syntax
        exclude: ^(frontend/|backend/)  # Exclude if using YAML in code

      # Check JSON files
      - id: check-json
        name: Check JSON syntax

      # Check TOML files
      - id: check-toml
        name: Check TOML syntax

      # Prevent adding large files
      - id: check-added-large-files
        name: Check for large files
        args: ['--maxkb=1000']

      # Check for private keys
      - id: detect-private-key
        name: Detect private keys

  # Python-specific hooks (backend)
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.8.4
    hooks:
      - id: ruff
        name: Ruff linter (Python)
        args: [--fix, --exit-non-zero-on-fix]
        files: ^backend/

      - id: ruff-format
        name: Ruff formatter (Python)
        files: ^backend/

  # Check for AWS credentials
  - repo: https://github.com/pre-commit/pygrep-hooks
    rev: v1.10.0
    hooks:
      - id: python-check-blanket-noqa
        name: Check blanket noqa
        files: ^backend/.*\.py$

      - id: python-check-mock-methods
        name: Check mock methods
        files: ^backend/.*\.py$

      - id: python-no-eval
        name: Prevent eval usage
        files: ^backend/.*\.py$

      - id: python-no-log-warn
        name: Use logger.warning instead of warn
        files: ^backend/.*\.py$

      - id: text-unicode-replacement-char
        name: Detect unicode replacement character

  # Additional security checks
  - repo: local
    hooks:
      # Check for .env files (but allow .env.example and .env.*.example)
      - id: check-env-files
        name: Check for .env files
        entry: bash -c 'if git diff --cached --name-only | grep -E "\.env$|\.env\.local$|\.env\.development$|\.env\.production$" | grep -v "\.example$"; then echo "ERROR: .env file detected in commit. These should not be committed."; exit 1; fi'
        language: system
        pass_filenames: false
        always_run: true

      # Check for TODO/FIXME without issue reference
      - id: check-todos
        name: Check TODOs have issue reference
        entry: bash -c 'if git diff --cached | grep -E "^\+.*TODO(?!.*#[0-9]+)|^\+.*FIXME(?!.*#[0-9]+)"; then echo "WARNING: TODO/FIXME found without issue reference (e.g., TODO #123)"; fi'
        language: system
        pass_filenames: false
        always_run: true
        verbose: true
        stages: [commit]

      # Validate backend .env.example
      - id: validate-env-example
        name: Validate .env.example files
        entry: bash -c 'cd backend && python -c "import sys; from pathlib import Path; content = Path(\".env.example\").read_text(); sys.exit(0 if \"your-secret-key-here\" in content.lower() or \"replace-in-production\" in content.lower() else 1)" || (echo "ERROR: .env.example must contain placeholder values, not real secrets"; exit 1)'
        language: system
        pass_filenames: false
        files: ^backend/\.env\.example$

# Global settings
default_language_version:
  python: python3.12

# Configuration
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit hooks

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: '[pre-commit.ci] pre-commit autoupdate'
  autoupdate_schedule: weekly
  skip: []
  submodules: false
